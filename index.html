<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Reinvent Your Revolution</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Permanent+Marker&display=swap" rel="stylesheet">
    <style>
        .fancy-text {
            font-family: 'Permanent Marker', cursive;
        }
    </style>
</head>
<body class="bg-gradient-to-r from-purple-500 to-pink-500 min-h-screen p-8">
    <div class="max-w-2xl mx-auto">
        <!-- Add logout button -->
        <div class="flex justify-end mb-4 gap-2">
            <button onclick="resetGoal()" 
                    class="bg-red-500 text-white px-4 py-2 rounded-lg hover:bg-red-600">
                Reset Goal
            </button>
            <button onclick="logout()" 
                    class="bg-white text-purple-600 px-4 py-2 rounded-lg hover:bg-gray-100">
                Logout
            </button>
        </div>

        <!-- Title with lightning emoji -->
        <h1 class="text-center fancy-text mb-8 text-white flex items-center justify-center gap-2 text-2xl sm:text-3xl md:text-4xl">
            <span>‚ö°Ô∏è</span>
            <span>Reinvent Your Revolution</span>
            <span>‚ö°Ô∏è</span>
        </h1>

        <!-- Goal input section -->
        <div class="bg-white rounded-lg p-6 mb-8 shadow-lg">
            <input type="text" id="revolutionGoal" 
                   class="w-full p-3 border rounded-lg mb-4" 
                   placeholder="What's your next revolution">
            <button onclick="setGoal()" 
                    class="w-full bg-purple-600 text-white py-2 rounded-lg hover:bg-purple-700">
                Set Goal
            </button>
        </div>

        <!-- Add this section after the Goal input section and before the Emoji face section -->
        <div id="goalTypeSelector" class="bg-white rounded-lg p-6 mb-8 shadow-lg hidden">
            <h2 class="text-xl mb-4 text-center text-gray-700">How would you like to achieve this goal?</h2>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <button onclick="selectGoalType('tasks')" 
                        class="p-6 border-2 border-purple-200 rounded-lg hover:border-purple-500 transition-all">
                    <div class="text-2xl mb-2">üìã</div>
                    <h3 class="font-bold mb-2">Tasks Based</h3>
                    <p class="text-sm text-gray-600">Break down your goal into specific tasks and track their progress</p>
                </button>
                <button onclick="selectGoalType('habits')" 
                        class="p-6 border-2 border-purple-200 rounded-lg hover:border-purple-500 transition-all">
                    <div class="text-2xl mb-2">üîÑ</div>
                    <h3 class="font-bold mb-2">Habits Based</h3>
                    <p class="text-sm text-gray-600">Create daily habits to gradually achieve your goal</p>
                </button>
            </div>
        </div>

        <!-- Emoji face -->
        <div id="emojiContainer" class="text-center text-8xl mb-8 hidden">
            <div id="emojiFace">üéØ</div>
            <div id="progressText" class="text-white text-xl mt-4"></div>
        </div>

        <!-- Tasks section -->
        <div id="tasksContainer" class="hidden">
            <div class="bg-white rounded-lg p-6 shadow-lg">
                <div id="tasksList"></div>
                <button onclick="addTask()" 
                        id="addTaskBtn" 
                        class="w-full bg-green-600 text-white py-2 rounded-lg mt-4 hover:bg-green-700">
                    Add Task
                </button>
            </div>
        </div>

        <!-- Add this section for habits input -->
        <div id="habitsContainer" class="hidden">
            <div class="bg-white rounded-lg p-6 shadow-lg">
                <h2 class="text-xl mb-4 text-gray-700">Define Your Daily Habits (1-3)</h2>
                <div id="habitsList" class="space-y-4"></div>
                <button onclick="addHabit()" 
                        id="addHabitBtn" 
                        class="w-full bg-green-600 text-white py-2 rounded-lg mt-4 hover:bg-green-700">
                    Add Habit
                </button>
                <button onclick="startHabitTracking()" 
                        id="startHabitsBtn" 
                        class="w-full bg-purple-600 text-white py-2 rounded-lg mt-4 hover:bg-purple-700">
                    Start 30-Day Challenge
                </button>
            </div>
        </div>
    </div>

    <script>
        // Add these functions at the beginning of your script section
        function checkAuth() {
            const currentUser = localStorage.getItem('currentUser');
            if (!currentUser) {
                window.location.href = 'signup.html';
            }
            return currentUser;
        }

        function logout() {
            localStorage.removeItem('currentUser');
            window.location.href = 'signup.html';
        }

        // Add this line at the beginning of your script section
        const currentUser = checkAuth();

        let tasks = [];
        let completedGoals = [];
        const MAX_INITIAL_TASKS = 5;
        let currentRevolutionNumber = 1;
        let goalType = null;
        let habits = [];
        const MAX_HABITS = 3;

        function setGoal() {
            const goal = document.getElementById('revolutionGoal').value;
            if (goal.trim() === '') return;
            
            // Get users and update current user's data
            let users = JSON.parse(localStorage.getItem('users') || '[]');
            const userIndex = users.findIndex(u => u.username === currentUser);
            if (userIndex !== -1) {
                users[userIndex].currentGoal = goal;
                localStorage.setItem('users', JSON.stringify(users));
            }
            
            document.getElementById('revolutionGoal').disabled = true;
            document.getElementById('goalTypeSelector').classList.remove('hidden');
        }

        function selectGoalType(type) {
            // Check if goal type was already selected
            let users = JSON.parse(localStorage.getItem('users') || '[]');
            const userIndex = users.findIndex(u => u.username === currentUser);
            
            if (userIndex !== -1 && users[userIndex].goalType) {
                alert('Goal type already selected. Reset goal to change type.');
                return;
            }

            goalType = type;
            
            if (userIndex !== -1) {
                users[userIndex].goalType = type;
                users[userIndex].tasks = [];
                users[userIndex].habits = [];
                localStorage.setItem('users', JSON.stringify(users));
            }

            document.getElementById('goalTypeSelector').classList.add('hidden');
            document.getElementById('emojiContainer').classList.remove('hidden');

            if (type === 'tasks') {
                tasks = [];
                document.getElementById('tasksContainer').classList.remove('hidden');
            } else {
                habits = [];
                document.getElementById('habitsContainer').classList.remove('hidden');
            }
            updateEmoji();
        }

        function addTask() {
            if (tasks.length >= MAX_INITIAL_TASKS) {
                alert('Maximum 5 tasks allowed at a time!');
                return;
            }

            const taskHtml = `
                <div class="task mb-4 p-4 border rounded-lg">
                    <div class="flex justify-between items-start mb-2">
                        <input type="text" 
                               class="w-full p-2 border rounded mr-2" 
                               placeholder="Enter task description"
                               onchange="saveTaskDescription(this)">
                        <button onclick="deleteTask(this)" 
                                class="text-red-500 hover:text-red-700 p-2">
                            ‚ùå
                        </button>
                    </div>
                    <div class="flex items-center">
                        <select class="w-24 p-2 border rounded"
                                onchange="updateProgress(this)">
                            <option value="0">0%</option>
                            <option value="20">20%</option>
                            <option value="40">40%</option>
                            <option value="60">60%</option>
                            <option value="80">80%</option>
                            <option value="100">100%</option>
                        </select>
                    </div>
                </div>
            `;
            
            document.getElementById('tasksList').insertAdjacentHTML('beforeend', taskHtml);
            tasks.push({ description: '', progress: 0 });
            saveTasksToStorage();
            updateAddTaskButton();
        }

        function saveTaskDescription(input) {
            const taskDiv = input.closest('.task');
            const taskIndex = Array.from(taskDiv.parentNode.children).indexOf(taskDiv);
            tasks[taskIndex].description = input.value;
            saveTasksToStorage();
        }

        function updateProgress(input) {
            const taskDiv = input.closest('.task');
            const taskIndex = Array.from(taskDiv.parentNode.children).indexOf(taskDiv);
            const newProgress = parseInt(input.value) || 0;
            
            tasks[taskIndex].progress = newProgress;
            saveTasksToStorage();
            
            if (newProgress === 100) {
                moveTaskToDone(taskDiv, taskIndex);
                checkRevolutionComplete();
            }
            
            updateEmoji();
            updateAddTaskButton();
        }

        function saveTasksToStorage() {
            let users = JSON.parse(localStorage.getItem('users') || '[]');
            const userIndex = users.findIndex(u => u.username === currentUser);
            if (userIndex !== -1) {
                users[userIndex].tasks = tasks;
                localStorage.setItem('users', JSON.stringify(users));
            }
        }

        function loadUserData() {
            const users = JSON.parse(localStorage.getItem('users') || '[]');
            const user = users.find(u => u.username === currentUser);
            
            if (user && user.currentGoal) {
                document.getElementById('revolutionGoal').value = user.currentGoal;
                document.getElementById('revolutionGoal').disabled = true;
                document.getElementById('emojiContainer').classList.remove('hidden');
                
                if (user.goalType === 'tasks') {
                    tasks = user.tasks || [];
                    document.getElementById('tasksContainer').classList.remove('hidden');
                    const tasksList = document.getElementById('tasksList');
                    tasksList.innerHTML = '';
                    
                    tasks.forEach(task => {
                        const taskHtml = task.progress === 100 ? `
                            <div class="task mb-4 p-4 border rounded-lg bg-gray-100">
                                <div class="flex justify-between items-start">
                                    <div class="text-gray-700">${task.description}</div>
                                    <button onclick="deleteTask(this)" 
                                            class="text-red-500 hover:text-red-700 p-2">
                                        ‚ùå
                                    </button>
                                </div>
                                <div class="flex items-center">
                                    <span class="text-green-600 font-bold">Completed 100%</span>
                                    <span class="ml-2 text-green-600">‚úì</span>
                                </div>
                            </div>
                        ` : `
                            <div class="task mb-4 p-4 border rounded-lg">
                                <div class="flex justify-between items-start mb-2">
                                    <input type="text" 
                                           class="w-full p-2 border rounded mr-2" 
                                           value="${task.description}"
                                           onchange="saveTaskDescription(this)">
                                    <button onclick="deleteTask(this)" 
                                            class="text-red-500 hover:text-red-700 p-2">
                                        ‚ùå
                                    </button>
                                </div>
                                <div class="flex items-center">
                                    <select class="w-24 p-2 border rounded"
                                            onchange="updateProgress(this)">
                                        <option value="0" ${task.progress === 0 ? 'selected' : ''}>0%</option>
                                        <option value="20" ${task.progress === 20 ? 'selected' : ''}>20%</option>
                                        <option value="40" ${task.progress === 40 ? 'selected' : ''}>40%</option>
                                        <option value="60" ${task.progress === 60 ? 'selected' : ''}>60%</option>
                                        <option value="80" ${task.progress === 80 ? 'selected' : ''}>80%</option>
                                        <option value="100" ${task.progress === 100 ? 'selected' : ''}>100%</option>
                                    </select>
                                </div>
                            </div>
                        `;
                        tasksList.insertAdjacentHTML('beforeend', taskHtml);
                    });
                    
                    updateEmoji();
                    updateAddTaskButton();
                } else if (user.goalType === 'habits') {
                    habits = user.habits || [];
                    document.getElementById('habitsContainer').classList.remove('hidden');
                    const habitsList = document.getElementById('habitsList');
                    habitsList.innerHTML = '';
                    
                    habits.forEach(habit => {
                        const habitHtml = `
                            <div class="habit p-4 border rounded-lg">
                                <input type="text" 
                                       class="w-full p-2 border rounded mb-2" 
                                       value="${habit.description}"
                                       onchange="saveHabitDescription(this)">
                                <div class="text-sm text-gray-600">
                                    This habit will be tracked for 30 days
                                </div>
                            </div>
                        `;
                        habitsList.insertAdjacentHTML('beforeend', habitHtml);
                    });
                    
                    updateAddHabitButton();
                }
                
                updateEmoji();
            }
            
            updateCompletedGoalsSection();
        }

        function moveTaskToDone(taskDiv, taskIndex) {
            const taskDescription = taskDiv.querySelector('input[type="text"]').value;
            const doneTaskHtml = `
                <div class="task mb-4 p-4 border rounded-lg bg-gray-100">
                    <div class="flex justify-between items-start">
                        <div class="text-gray-700">${taskDescription}</div>
                        <button onclick="deleteTask(this)" 
                                class="text-red-500 hover:text-red-700 p-2">
                            ‚ùå
                        </button>
                    </div>
                    <div class="flex items-center">
                        <span class="text-green-600 font-bold">Completed 100%</span>
                        <span class="ml-2 text-green-600">‚úì</span>
                    </div>
                </div>
            `;
            
            // Replace the existing task HTML but keep the task in the array
            taskDiv.outerHTML = doneTaskHtml;
        }

        function checkRevolutionComplete() {
            const activeTasksCount = tasks.filter(task => task.progress < 100).length;
            
            if (activeTasksCount === 0 && tasks.length > 0) {
                setTimeout(() => {
                    alert(`üéâ Incredible achievement! You've completed all tasks for your revolution!

üåü Take time to celebrate this success - you've earned it!

Your achievement has been added to your success story below.

When you feel ready for your next challenge, you can set a new goal. Until then, enjoy this moment! üéä`);
                    
                    archiveCurrentRevolution();
                }, 500);
            }
        }

        function archiveCurrentRevolution() {
            const currentGoal = document.getElementById('revolutionGoal').value;
            const completedTasksElements = document.querySelectorAll('.task');
            // Only store the description of completed tasks, nothing else
            const completedTasksList = Array.from(completedTasksElements).map(task => ({
                description: task.querySelector('input[type="text"], .text-gray-700').value || 
                            task.querySelector('input[type="text"], .text-gray-700').textContent.trim(),
                completed: true
            }));

            // Get the current user's data
            let users = JSON.parse(localStorage.getItem('users') || '[]');
            const userIndex = users.findIndex(u => u.username === currentUser);
            
            if (userIndex !== -1) {
                // Initialize completedGoals array if it doesn't exist
                users[userIndex].completedGoals = users[userIndex].completedGoals || [];
                
                // Add the completed goal
                users[userIndex].completedGoals.push({
                    number: users[userIndex].completedGoals.length + 1,
                    goal: currentGoal,
                    tasks: completedTasksList,
                    completedDate: new Date().toISOString(),
                    type: users[userIndex].goalType
                });

                // Clear current goal data
                users[userIndex].currentGoal = '';
                users[userIndex].goalType = null;
                users[userIndex].tasks = [];
                users[userIndex].habits = [];
                
                localStorage.setItem('users', JSON.stringify(users));
            }

            // Reset local variables
            tasks = [];
            habits = [];
            goalType = null;

            // Reset UI
            document.getElementById('revolutionGoal').value = '';
            document.getElementById('revolutionGoal').disabled = false;
            document.getElementById('tasksList').innerHTML = '';
            document.getElementById('emojiContainer').classList.add('hidden');
            document.getElementById('tasksContainer').classList.add('hidden');
            document.getElementById('habitsContainer').classList.add('hidden');
            document.getElementById('goalTypeSelector').classList.add('hidden');

            updateCompletedGoalsSection();
        }

        function updateCarousel() {
            // Create carousel if it doesn't exist
            let carousel = document.getElementById('completedRevolutions');
            if (!carousel) {
                const carouselHtml = `
                    <div id="completedRevolutions" class="mt-8 bg-white rounded-lg p-6 shadow-lg">
                        <h2 class="text-2xl mb-4 fancy-text text-purple-600">Completed Revolutions</h2>
                        <div id="carouselContent"></div>
                    </div>
                `;
                document.querySelector('.max-w-2xl').insertAdjacentHTML('beforeend', carouselHtml);
                carousel = document.getElementById('completedRevolutions');
            }

            // Update carousel content
            const carouselContent = document.getElementById('carouselContent');
            carouselContent.innerHTML = completedGoals.map(revolution => `
                <div class="mb-6 p-4 border rounded-lg bg-gray-50">
                    <h3 class="text-xl font-bold mb-2">Revolution ${revolution.number}.0</h3>
                    <p class="text-gray-700 mb-2">${revolution.goal}</p>
                    <div class="pl-4">
                        ${revolution.tasks.map(task => `
                            <div class="text-gray-600">
                                ‚úì ${task.description}
                            </div>
                        `).join('')}
                    </div>
                </div>
            `).join('');
        }

        function canAddNewTask() {
            return tasks.some(task => task.progress === 100);
        }

        function updateAddTaskButton() {
            const addTaskBtn = document.getElementById('addTaskBtn');
            addTaskBtn.disabled = tasks.length >= MAX_INITIAL_TASKS;
            addTaskBtn.style.opacity = addTaskBtn.disabled ? '0.5' : '1';
        }

        function updateEmoji() {
            const emojiFace = document.getElementById('emojiFace');
            const progressText = document.getElementById('progressText');

            if (goalType === 'habits') {
                if (habits.length === 0) {
                    progressText.textContent = 'Plant your habits to watch them grow';
                    emojiFace.textContent = 'üå±';
                    return;
                }
                
                const totalProgress = habits.reduce((sum, habit) => sum + (habit.daysCompleted || 0), 0) / (habits.length * 30) * 100;
                const roundedProgress = Math.round(totalProgress);
                
                if (roundedProgress < 25) {
                    emojiFace.textContent = 'üå±';
                } else if (roundedProgress < 50) {
                    emojiFace.textContent = 'üåø';
                } else if (roundedProgress < 75) {
                    emojiFace.textContent = 'üå∏';
                } else if (roundedProgress < 100) {
                    emojiFace.textContent = 'üå∫';
                } else {
                    emojiFace.textContent = 'üå≥';
                }

                progressText.textContent = `Habit Growth: ${roundedProgress}%`;
            } else {
                if (tasks.length === 0) {
                    progressText.textContent = 'Overall Progress: 0%';
                    emojiFace.textContent = 'üéØ';
                    return;
                }
                
                const totalProgress = tasks.reduce((sum, task) => sum + task.progress, 0) / tasks.length;
                const roundedProgress = Math.round(totalProgress);
                
                if (roundedProgress < 33) {
                    emojiFace.textContent = 'üéØ';
                } else if (roundedProgress < 66) {
                    emojiFace.textContent = 'üèÖ';
                } else if (roundedProgress < 100) {
                    emojiFace.textContent = 'üèÜ';
                } else {
                    emojiFace.textContent = 'üëë';
                }

                progressText.textContent = `Overall Progress: ${roundedProgress}%`;
            }
        }

        function addHabit() {
            if (habits.length >= MAX_HABITS) {
                alert('Maximum 3 habits allowed!');
                return;
            }

            const habitHtml = `
                <div class="habit p-4 border rounded-lg">
                    <input type="text" 
                           class="w-full p-2 border rounded mb-2" 
                           placeholder="Describe your daily habit"
                           onchange="saveHabitDescription(this)">
                    <div class="text-sm text-gray-600">
                        This habit will be tracked for 30 days
                    </div>
                </div>
            `;
            
            document.getElementById('habitsList').insertAdjacentHTML('beforeend', habitHtml);
            habits.push({ description: '', daysCompleted: 0, streak: 0 });
            saveHabitsToStorage();
            updateAddHabitButton();
        }

        function saveHabitDescription(input) {
            const habitDiv = input.closest('.habit');
            const habitIndex = Array.from(habitDiv.parentNode.children).indexOf(habitDiv);
            habits[habitIndex].description = input.value;
            saveHabitsToStorage();
        }

        function saveHabitsToStorage() {
            let users = JSON.parse(localStorage.getItem('users') || '[]');
            const userIndex = users.findIndex(u => u.username === currentUser);
            if (userIndex !== -1) {
                users[userIndex].habits = habits;
                localStorage.setItem('users', JSON.stringify(users));
            }
        }

        function updateAddHabitButton() {
            const addHabitBtn = document.getElementById('addHabitBtn');
            addHabitBtn.disabled = habits.length >= MAX_HABITS;
            addHabitBtn.style.opacity = addHabitBtn.disabled ? '0.5' : '1';
        }

        function startHabitTracking() {
            if (habits.length === 0) {
                alert('Please add at least one habit!');
                return;
            }

            if (habits.some(h => !h.description)) {
                alert('Please describe all habits!');
                return;
            }

            // Initialize habit tracking
            habits.forEach(habit => {
                habit.startDate = new Date().toISOString();
                habit.daysCompleted = 0;
                habit.streak = 0;
                habit.lastChecked = null;
            });

            saveHabitsToStorage();
            // Here you would transition to the habit tracking view
            // You might want to create a separate page for daily habit tracking
            alert('Habit tracking started! (You would implement the daily tracking UI here)');
        }

        function resetGoal() {
            if (confirm('Are you sure you want to reset your current goal? This will delete all related tasks/habits.')) {
                let users = JSON.parse(localStorage.getItem('users') || '[]');
                const userIndex = users.findIndex(u => u.username === currentUser);
                
                if (userIndex !== -1) {
                    // Reset user's goal data
                    users[userIndex].currentGoal = '';
                    users[userIndex].goalType = null;
                    users[userIndex].tasks = [];
                    users[userIndex].habits = [];
                    localStorage.setItem('users', JSON.stringify(users));
                }

                // Reset local variables
                tasks = [];
                habits = [];
                goalType = null;

                // Reset UI
                document.getElementById('revolutionGoal').value = '';
                document.getElementById('revolutionGoal').disabled = false;
                document.getElementById('goalTypeSelector').classList.add('hidden');
                document.getElementById('emojiContainer').classList.add('hidden');
                document.getElementById('tasksContainer').classList.add('hidden');
                document.getElementById('habitsContainer').classList.add('hidden');
                document.getElementById('tasksList').innerHTML = '';
                document.getElementById('habitsList').innerHTML = '';
            }
        }

        function deleteTask(button) {
            const taskDiv = button.closest('.task');
            const taskIndex = Array.from(taskDiv.parentNode.children).indexOf(taskDiv);
            
            // Remove task from array
            tasks.splice(taskIndex, 1);
            
            // Remove task from DOM
            taskDiv.remove();
            
            // Update storage and UI
            saveTasksToStorage();
            updateEmoji();
            updateAddTaskButton();
        }

        function updateCompletedGoalsSection() {
            // Create completed goals section if it doesn't exist
            let completedSection = document.getElementById('completedGoals');
            if (!completedSection) {
                const sectionHtml = `
                    <div id="completedGoals" class="mt-8 bg-white rounded-lg p-6 shadow-lg">
                        <h2 class="text-2xl mb-4 fancy-text text-purple-600">Your Achievements üèÜ</h2>
                        <div id="completedGoalsContent" class="space-y-4"></div>
                    </div>
                `;
                document.querySelector('.max-w-2xl').insertAdjacentHTML('beforeend', sectionHtml);
                completedSection = document.getElementById('completedGoals');
            }

            // Get user's completed goals
            const users = JSON.parse(localStorage.getItem('users') || '[]');
            const user = users.find(u => u.username === currentUser);
            const completedGoals = user?.completedGoals || [];

            // Update completed goals content
            const content = document.getElementById('completedGoalsContent');
            content.innerHTML = completedGoals.map(revolution => `
                <div class="p-4 border rounded-lg bg-gradient-to-r from-purple-50 to-pink-50">
                    <div class="flex items-center justify-between mb-2">
                        <h3 class="text-xl font-bold text-purple-600">Revolution ${revolution.number}.0</h3>
                        <span class="text-sm text-gray-500">
                            ${new Date(revolution.completedDate).toLocaleDateString()}
                        </span>
                    </div>
                    <p class="text-gray-700 mb-3 font-medium">${revolution.goal}</p>
                    <div class="pl-4 space-y-1">
                        ${revolution.tasks.map(task => `
                            <div class="text-gray-600">
                                <span class="text-green-500 mr-2">‚úì</span>
                                ${task.description}
                            </div>
                        `).join('')}
                    </div>
                    <div class="mt-2 text-sm text-gray-500 italic">
                        Achieved through: ${revolution.type === 'tasks' ? 'Task completion' : 'Habit formation'}
                    </div>
                </div>
            `).join('');
        }

        // Call loadUserData after checking auth
        loadUserData();
    </script>
</body>
</html> 